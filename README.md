# Система Аутентификации и Авторизации

## Описание системы

Полнофункциональная система аутентификации и авторизации на Django REST Framework с кастомной моделью пользователя, JWT токенами и гибкой системой управления доступом на основе ролей и разрешений.

## Архитектура системы

### Модели данных

1. **User** - кастомная модель пользователя с email-аутентификацией
2. **Role** - роли пользователей (Admin, Manager, User и т.д.)
3. **BusinessElement** - бизнес-элементы системы (продукты, заказы, пользователи)
4. **AccessRule** - правила доступа ролей к бизнес-элементам
5. **UserRole** - связь пользователей с ролями (многие-ко-многим)

### Права доступа

Для каждого бизнес-элемента определены гранулярные права:

- `read_permission` - чтение собственных объектов
- `read_all_permission` - чтение всех объектов
- `create_permission` - создание объектов
- `update_permission` - обновление собственных объектов
- `update_all_permission` - обновление всех объектов
- `delete_permission` - удаление собственных объектов
- `delete_all_permission` - удаление всех объектов

## Функциональные возможности

### Аутентификация
- **JWT токены** для безопасной аутентификации
- **Кастомная модель User** с email вместо username
- **Автоматическое обновление** JWT токенов
- **Middleware** для автоматической аутентификации по заголовкам

### Авторизация
- **Ролевая модель доступа** (RBAC)
- **Гибкие правила доступа** на уровне бизнес-элементов
- **Декораторы** для проверки прав в представлениях
- **Проверка прав** на уровне объектов и действий

### Безопасность
- **passlib** для хеширования паролей
- **Мягкое удаление** пользователей
- **Валидация токенов** с обработкой исключений
- **Защита от несанкционированного доступа**

### Управление
- **API для администрирования** ролей и прав
- **Назначение ролей** пользователям
- **Управление бизнес-элементами** системы
- **Логирование** действий системы

## Технологический стек

- **Backend**: Django 4.2+, Django REST Framework
- **База данных**: PostgreSQL
- **Аутентификация**: JWT (PyJWT)
- **Хеширование паролей**: passlib (pbkdf2_sha256)
- **Контейнеризация**: Docker, Docker Compose
- **Документация**: Django REST Framework API

## Установка и запуск

### Требования
- Python 3.9+
- PostgreSQL 12+
- Docker и Docker Compose (опционально)


**Клонирование репозитория**
```bash
git clone https://github.com/Alexsandr007/test_custom_auth.git
```

### Запуск через Docker
### Сборка и запуск контейнеров

```bash
docker-compose up --build
```


### API Endpoints
### Аутентификация
POST /api/auth/register/ - Регистрация нового пользователя

POST /api/auth/login/ - Вход в систему (получение JWT токена)

POST /api/auth/logout/ - Выход из системы

GET /api/auth/profile/ - Получение профиля пользователя

PUT /api/auth/profile/ - Обновление профиля пользователя

DELETE /api/auth/delete/ - Мягкое удаление аккаунта

### Управление доступом
GET /api/access/roles/ - Список всех ролей

POST /api/access/roles/ - Создание новой роли

GET /api/access/rules/ - Список правил доступа

POST /api/access/rules/ - Создание нового правила доступа

GET /api/access/user-roles/ - Назначения ролей пользователям

POST /api/access/user-roles/ - Назначение роли пользователю

### Бизнес-логика (Mock)
GET /api/business/products/ - Список продуктов (требует права доступа)

GET /api/business/orders/ - Список заказов (требует права доступа)



# Тестирование

## Автоматическое тестирование

Система включает комплексные тесты для проверки всех компонентов аутентификации, авторизации и управления доступом. Тесты расположены в папке `tests_files/` в корне проекта.

### Структура тестов

- `full_test.py` - Полный интеграционный тест всей системы
- `test_access_errors.py` - Тестирование ошибок доступа и валидации прав
- `test_permission_levels.py` - Тестирование различных уровней разрешений
- `test_token.py` - Тестирование JWT токенов и аутентификации

## Запуск тестов


### Запустите все тесты:

```bash
docker-compose exec web python tests_files/full_test.py
```

### Запуск отдельных тестовых модулей:

```bash
# Тестирование токенов
docker-compose exec web python tests_files/test_token.py

# Тестирование уровней доступа
docker-compose exec web python tests_files/test_permission_levels.py

# Тестирование ошибок доступа
docker-compose exec web python tests_files/test_access_errors.py
```

